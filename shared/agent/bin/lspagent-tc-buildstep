#!/usr/bin/env python3

#desc# Standard interface to CodeStream's TeamCity build process for the LSP Agent

import os
import sys

sys.path.append(os.environ['DT_TOP'] + "/lib")
import devTools
from sysUtils import dumpDict, shellExecNoBuffer, someValueOrNone
from buildUtils import *

#assetExtensionList = ['info', 'vsix']

args = parseStandardBuildArgs()
dt = devTools.devTools()
buildData = buildInit(__file__, dt, args)
os.chdir(buildData['sandboxTop'])
if args.verbose: print("current directory is", buildData['sandboxTop'])
if args.debug: dumpDict(buildData, None, buildData)

if args.action == 'prep':
	buildstepPrep(args)
	exit(0)

if args.action in ['clean','destroy']:
	buildstepGeneric(args, cmd = "npm run clean:ci", workingDir = buildData['sandboxTop'])

if args.action == 'destroy':
	buildstepDestroy(args, buildData)

if args.action == 'build':
	print("there is no build for the agent yet")

if args.action == 'citest':
	print("Running tests against API service at", os.environ['LSPAGENT_API_ORIGIN'])
	buildstepGeneric(args, cmd = "npm run bash-test-unit-ci")
	buildstepGeneric(args, cmd = "npm run bash-test-acceptance-ci")
	# buildstepGeneric(args, cmd = "npm run bash-test-integration-ci")

if args.action == 'publish':
	print("there are not assets for the agent yet")
