#!/usr/bin/env python3

#desc# Standard interface to CodeStream's TeamCity build process for the VS Code Extension

import os
import sys

sys.path.append(os.environ['DT_TOP'] + "/lib")
import devTools
import gitCS
from sysUtils import dumpDict, shellExecNoBuffer, someValueOrNone
from buildUtils import *

supplementalRepos = ['codestream-components', 'codestream-lsp-agent']
allRepos = supplementalRepos + ['vscode-codestream']
assetExtensionList = ['info', 'vsix']

args = parseStandardBuildArgs()
dt = devTools.devTools()
buildData = buildInit(__file__, dt, args)
os.chdir(buildData['sandboxTop'])
if args.verbose: print("current directory is", buildData['sandboxTop'])
if args.debug: dumpDict(buildData, None, buildData)
git = {}
for repo in allRepos:
	git[repo] = gitCS.gitCS(os.environ['VSCSB_SANDBOX'] + "/" + repo)

if args.update_repos:
	for repo in supplementalRepos:
		if not git[repo].pull("origin", rebase = True):
			print("pull/rebase failed for", repo)
			exit(1)

if args.action == 'prep':
	buildstepPrep(args)
	exit(0)

if args.action in ['clean','destroy']:
	buildstepGeneric(args, cmd = "npm run clean:ci", workingDir = buildData['sandboxTop'])

if args.action == 'destroy':
	buildstepDestroy(args, buildData, repoList = allRepos)

# for a build:
#   npm run build
#   create generic info file (no build number)
#   npm run pack (create the vsix with a generic name - no build number)
#   create build number specific info file (includes md5sum of vsix)
#   rename generic vsix to build specific vsix
pkgInfo = None
vsixFile = None
infoFile = None
gitVSCode = gitCS.gitCS(buildData['sandboxTop'])
if args.action in ['build','info','release']:
	if args.action == 'build':
		# build the extension
		shellExecNoBuffer("npm run bundle:ci", abortOnFail = True, printCmd = args.verbose)

	# create asset info file (w/o md5sum)
	pkgInfo = getPackageInfo(buildData = buildData, gitRepoCommitDir = buildData['sandboxTop'])
	genericName = pkgInfo['name'] + "-" + pkgInfo['version']
	genericVsixFile = genericName + ".vsix"
	genericInfoFile = genericName + ".info"
	vsixFile = pkgInfo['localAssetFilePrefix'] + ".vsix"
	infoFile = pkgInfo['localAssetFilePrefix'] + ".info"
	for repo in supplementalRepos:
		git = gitCS.gitCS(os.environ['VSCSB_SANDBOX'] + "/" + repo)
		pkgInfo['repoCommitId'][repo] = git.getCommitId()
	pkgInfo['assetsMD5'][vsixFile] = "0"
	dumpDict(pkgInfo, genericInfoFile)
	if args.verbose: print("created preliminary info file", genericInfoFile)

	if args.action == 'build':
		# pack the extenstion (uses genericInfoFile, creates genericVsixFile)
		shellExecNoBuffer("npm run pack", abortOnFail = True, printCmd = args.verbose)
		md5sum = dt.md5Hash(genericVsixFile)
		pkgInfo['assetsMD5'][vsixFile] = md5sum
		dumpDict(pkgInfo, infoFile)
		os.unlink(genericInfoFile)
		os.rename(genericVsixFile, vsixFile)
		if args.verbose:
			dumpDict(pkgInfo, None, "packageInfo:")
			shellExecNoBuffer("ls -l " + pkgInfo['localAssetFilePrefix'] + ".*", printCmd = True)

if args.action == 'citest':
	buildstepGeneric(args, cmd = "echo Testing not configured")

if args.action == 'publish':
	publishArtifacts(args, buildData, assetExtensionList)

if args.action == 'release':
	if not os.path.exists(vsixFile):
		print("asset not found:", vsixFile)
		exit(1)
	if not os.path.exists(infoFile):
		print("asset not found:", infoFile)
		exit(1)
	applyTagToRepos(os.environ['VSCSB_SANDBOX'], "vscode-" + pkgInfo['version'], pkgInfo['repoCommitId'])
	updatePackageVersion(buildData['sandboxTop'] + "/package.json", "develop", pkgInfo['version'], bumpLevel = 'patch')
	if not someValueOrNone(os.environ, 'VSCSB_NOPUBLISH'):
		buildstepGeneric(args, cmd = "vscsb-publish-assets-to-cloudfront --no-prompt --asset-env prod")
		buildstepGeneric(args, cmd = "vsce publish --packagePath " + vsixFile)
