<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
  <title>Is this necessary?</title>
  <link rel="stylesheet" href="vscode-resource:{% styles-path %}"/>
</head>

<body class="codestream preload">
  <div id='data' style="display: none;">{% bootstrap-data %}</div>
  <div id='app'>codestream stuff goes here</div>
  <script src="vscode-resource:{% script-path %}"></script>
  <script>
    const cssColorRegEx = /^(?:(#?)([0-9a-f]{3}|[0-9a-f]{6})|((?:rgb|hsl)a?)\((-?\d+%?)[,\s]+(-?\d+%?)[,\s]+(-?\d+%?)[,\s]*(-?[\d\.]+%?)?\))$/i;

    function adjustLight(color, amount) {
        const cc = color + amount;
        const c = amount < 0
            ? cc < 0 ? 0 : cc
            : cc > 255 ? 255 : cc;

        return Math.round(c);
    }

    function darken(color, percentage) {
        return lighten(color, -percentage);
    }

    function lighten(color, percentage) {
        const rgba = toRgba(color);
        if (rgba == null) return color;

        const [r, g, b, a] = rgba;
        percentage = (255 * percentage) / 100;
        return `rgba(${adjustLight(r, percentage)}, ${adjustLight(g, percentage)}, ${adjustLight(b, percentage)}, ${a})`
    }

    function opacity(color, percentage) {
        const rgba = toRgba(color);
        if (rgba == null) return color;

        const [r, g, b, a] = rgba;
        return `rgba(${r}, ${g}, ${b}, ${a * (percentage / 100)})`
    }

    function toRgba(color) {
        color = color.trim();

        const result = cssColorRegEx.exec(color);
        if (result == null) return null;

        if (result[1] === '#') {
            const hex = result[2];
            switch (hex.length) {
                case 3:
                    return [
                        parseInt(hex[0] + hex[0], 16),
                        parseInt(hex[1] + hex[1], 16),
                        parseInt(hex[2] + hex[2], 16),
                        1
                    ];
                case 6:
                    return [
                        parseInt(hex.substring(0, 2), 16),
                        parseInt(hex.substring(2, 4), 16),
                        parseInt(hex.substring(4, 6), 16),
                        1
                    ];
            }

            return null;
        }

        switch (result[3]) {
            case 'rgb':
            return [
                    parseInt(result[4], 10),
                    parseInt(result[5], 10),
                    parseInt(result[6], 10),
                    1
                ];
            case 'rgba':
                return [
                    parseInt(result[4], 10),
                    parseInt(result[5], 10),
                    parseInt(result[6], 10),
                    parseFloat(result[7])
                ];
            default:
                return null;
        }
    }

    function initializeColorPalette() {
        const onColorThemeChanged = () => {
            const body = document.body;
            const computedStyle = getComputedStyle(body);

            const bodyStyle = body.style;
            let color = computedStyle.getPropertyValue('--color').trim();
            bodyStyle.setProperty('--text-color', opacity(color, 80));
            bodyStyle.setProperty('--text-color-subtle', opacity(color, 60));
            bodyStyle.setProperty('--text-color-subtle--lighten-50', lighten(opacity(color, 60), 50));

            color = computedStyle.getPropertyValue('--background-color').trim();
            bodyStyle.setProperty('--app-background-color', lighten(color, 4));
            bodyStyle.setProperty('--app-background-color--lighten-03', lighten(color, 7));
            bodyStyle.setProperty('--base-background-color', opacity(lighten(color, 15), 40));
            bodyStyle.setProperty('--tool-panel-background-color-dark', lighten(color, 10));
            bodyStyle.setProperty('--tool-panel-background-color-light', darken(color, 10));

            // color = computedStyle.getPropertyValue('--link-color').trim();
            // bodyStyle.setProperty('--link-color--darken-20', darken(color, 20));
        };

        const observer = new MutationObserver(onColorThemeChanged);
        observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });

        onColorThemeChanged();
        return observer;
    }

    initializeColorPalette();

    setTimeout(() => {
        document.body.classList.remove('preload');
    }, 1000); // Wait for animations to complete
</script>
</body>

</html>
